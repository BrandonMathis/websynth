<html>
<head>
  <title>Home</title>
  <script src="./index.js"></script>
  <link rel="stylesheet" type="text/css" href="./index.css">
</head>

<body>
  <h2>MonoSynth</h2>
  <div class="synth-controls">
    <button class="power-button" data-input="power">‚èª</button>
    <button disabled class="toggle-oscillator" data-input="mic">Mic</button>
    <button disabled class="toggle-oscillator" data-input="sine">Sine</button>
    <button disabled class="toggle-oscillator" data-input="square">Square</button>
    <button disabled class="toggle-oscillator" data-input="saw">Saw</button>
    <button disabled class="toggle-oscillator" data-input="tri">Triangle</button>
    <button disabled class="enable-keyboard">Keys</button>
  </div>

  <div class="visualizers">
    <canvas id="gain-visualizer" width="800" height="100" class="visualizer"></canvas>

    <canvas id="frequency-visualizer" width="800" height="100" class="visualizer"></canvas>
  </div>

  <!-- Additional Visualization code -->
  <script>
    function drawGainPeaks(
      analyser,
      canvas,
      opts = { fillStyle: 'rgb(255, 255, 255)' }
    ) {
      const barWidth = 1;

      let then = new Date().getTime();
      const fps = 25;
      const interval = 1000 / fps;

      let ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(0, 0, 255, 0.5)';

      const WIDTH = canvas.width;
      const HEIGHT = canvas.height;

      const peaksCount = WIDTH;
      let peaks = new Array(WIDTH);
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength)

      function draw() {
        requestAnimationFrame(draw);

        // Timng vars for FPS
        var now = new Date().getTime();
        var delta = now - then;

        if (delta > interval) {
          then = now - (delta % interval);

          analyser.getByteFrequencyData(dataArray);
          let sum = 0
          for (const amplitude of dataArray) {
            sum += amplitude * amplitude
          }
          const currentLevel = Math.sqrt(sum / dataArray.length)

          if (currentLevel > -Infinity) {
            peaks.unshift(currentLevel);
          }

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          peaks.forEach((peak, index) => {
            ctx.fillStyle = opts.fillStyle;
            const barHeight = Math.max(1, peak);
            const x = barWidth * index;
            const y = HEIGHT / 2 - barHeight / 2;

            ctx.fillRect(x, y, barWidth, barHeight);

            // No need to keep record of peaks once waveform scrolls out of view
            if (peaks.length >= peaksCount) {
              peaks.splice(WIDTH);
            }
          });
        }
      }

      draw();
    }

    function drawOscilloscope(analyser, canvas) {
      const waveform = new Float32Array(analyser.frequencyBinCount);
      const ctx = canvas.getContext('2d');
      ctx.width = waveform.length;
      ctx.height = 100;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength)

      function draw() {
        requestAnimationFrame(draw);
        ctx.clearRect(0, 0, ctx.width, ctx.height);

        // Draw Frequency in Hz upper left corner
        analyser.getByteFrequencyData(dataArray);
        ctx.fillStyle = '#fff';
        ctx.font = '14px Courier';
        // Find the peak frequency bin
        let maxIndex = 0;
        let maxValue = 0;
        for (let i = 0; i < bufferLength; i++) {
          if (dataArray[i] > maxValue) {
            maxValue = dataArray[i];
            maxIndex = i;
          }
        }

        // Convert index to frequency
        const frequency = maxIndex * audioContext.sampleRate / analyser.fftSize;
        ctx.fillText(
          `Frequency: ${frequency} Hz`,
          10,
          20
        );

        // Draw Wave
        analyser.getFloatTimeDomainData(waveform);
        ctx.beginPath();
        for(let i = 0; i < waveform.length; i++) {
          const x = i;
          const y = ( 0.5 + (waveform[i] / 2) ) * ctx.height;

          if(i == 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      };
      draw();
    }
  </script>
</body>
