<html>
<head>
  <title>Home</title>
  <script src="./index.js"></script>
  <link rel="stylesheet" type="text/css" href="./index.css">
</head>

<body>
  <h2>MonoSynth</h2>
  <div class="synth-controls">
    <button class="power-button" data-input="power">‚èª</button>
    <button disabled class="toggle-oscillator" data-input="mic">Mic</button>
    <button disabled class="toggle-oscillator" data-input="sine">Sine</button>
    <button disabled class="toggle-oscillator" data-input="square">Square</button>
    <button disabled class="toggle-oscillator" data-input="saw">Saw</button>
    <button disabled class="toggle-oscillator" data-input="tri">Triangle</button>
    <button disabled class="enable-keyboard">Keys</button>
  </div>

  <div class="visualizers">
    <canvas id="gain-visualizer" width="800" height="100" class="visualizer"></canvas>

    <canvas id="frequency-visualizer" width="800" height="100" class="visualizer"></canvas>

    <svg id="keyboard" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 341">
      <defs>
      <style>
        .key--black {
          fill: #000747;
        }

        .key__fill {
          fill: #fafbff;
        }

        .key__stroke {
          fill: #000747;
        }

        .key__letter-background {
          fill: #eef0ff;
        }

        .key__letter {
          fill: #69f;
        }

        .key--white.playing .key__fill { fill: #ff4d4d; }
        .key--white.playing .key__stroke { fill: #ff0000; }
        .key--white.playing .key__letter { fill: #ff0000; }
        .key--white.playing .key__letter-background { fill: #ffaeae; }

      </style>
      </defs>
      <g id="key-z" class="key key--white">
      <g>
      <rect class="key__fill" x="1" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M148,2v337H2V2h146M150,0H0v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="25" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M60.36,282.64l21.84-28.8,1.02,2.04h-22.38v-7.2h28.38v7.98l-21.9,28.86-1.02-2.04h23.4v7.2h-29.34v-8.04Z"/>
      </g>
      </g>
      <g id="key-x" class="key key--white">
      <g>
      <rect class="key__fill" x="151" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M298,2v337h-146V2h146M300,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="175" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M221.88,267.28v4.32l-13.08-22.92h9.48l8.76,18.78v3.96l-9,19.26h-9.48l13.32-23.4ZM222.96,271.42v-3.96l8.76-18.78h9.48l-13.08,22.92v-4.32l13.32,23.4h-9.42l-9.06-19.26Z"/>
      </g>
      </g>
      <g id="key-c" class="key key--white">
      <g>
      <rect class="key__fill" x="301" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M448,2v337h-146V2h146M450,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="325" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M380.97,258.04c-1.18-1.6-3.03-2.4-5.55-2.4-1.96,0-3.52.47-4.68,1.41-1.16.94-2,2.43-2.52,4.47-.52,2.04-.78,4.76-.78,8.16s.27,6.23.81,8.25c.54,2.02,1.46,3.49,2.76,4.41,1.3.92,3.07,1.38,5.31,1.38,2,0,4.03-.36,6.09-1.08,2.06-.72,4.09-1.78,6.09-3.18v7.74c-2.2,1.32-4.42,2.33-6.66,3.03-2.24.7-4.52,1.05-6.84,1.05-3.36,0-6.24-.81-8.64-2.43s-4.24-3.95-5.52-6.99c-1.28-3.04-1.92-6.68-1.92-10.92,0-4.76.68-8.86,2.04-12.3,1.36-3.44,3.32-6.06,5.88-7.86,2.56-1.8,5.6-2.7,9.12-2.7,3.04,0,5.71.71,8.01,2.13,2.3,1.42,4.09,3.47,5.37,6.15,1.28,2.68,1.92,5.88,1.92,9.6h-8.52c0-3.68-.59-6.32-1.77-7.92Z"/>
      </g>
      </g>
      <g id="key-v" class="key key--white">
      <g>
      <rect class="key__fill" x="451" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M598,2v337h-146V2h146M600,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="475" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M513.45,270.79c-2.1-7.38-3.77-14.75-5.01-22.11h8.52c1.24,7.16,2.52,13.5,3.84,19.02,1.32,5.52,2.9,11.04,4.74,16.56h-1.08c1.84-5.56,3.42-11.1,4.74-16.62,1.32-5.52,2.6-11.84,3.84-18.96h8.52c-1.24,7.2-2.9,14.5-4.98,21.9-2.08,7.4-4.38,14.1-6.9,20.1h-9.3c-2.52-5.88-4.83-12.51-6.93-19.89Z"/>
      </g>
      </g>
      <g id="key-b" class="key key--white">
      <g>
      <rect class="key__fill" x="601" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M748,2v337h-146V2h146M750,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="625" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M661.26,248.68h14.22c4.44,0,7.82.88,10.14,2.64,2.32,1.76,3.48,4.26,3.48,7.5,0,2.44-.6,4.53-1.8,6.27-1.2,1.74-2.94,3.05-5.22,3.93l-.24-1.32c2.92.56,5.15,1.75,6.69,3.57,1.54,1.82,2.31,4.15,2.31,6.99,0,3.96-1.25,7.02-3.75,9.18-2.5,2.16-6.13,3.24-10.89,3.24h-14.94v-42ZM666.66,283.48h9.48c2.2,0,3.78-.43,4.74-1.29.96-.86,1.44-2.27,1.44-4.23,0-2.12-.48-3.63-1.44-4.53s-2.52-1.35-4.68-1.35h-9.18v-6.36h8.04c2,0,3.42-.39,4.26-1.17.84-.78,1.26-2.07,1.26-3.87s-.42-3-1.26-3.72c-.84-.72-2.26-1.08-4.26-1.08h-8.4l2.58-2.58v32.76l-2.58-2.58Z"/>
      </g>
      </g>
      <g id="key-n" class="key key--white">
      <g>
      <rect class="key__fill" x="751" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M898,2v337h-146V2h146M900,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="775" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M810.48,248.68h9.24l12.96,30.3-1.14.24v-30.54h7.98v42h-9.24l-12.96-30.3,1.14-.24v30.54h-7.98v-42Z"/>
      </g>
      </g>
      <g id="key-m" class="key key--white">
      <g>
      <rect class="key__fill" x="901" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M1048,2v337h-146V2h146M1050,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="925" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M960.84,248.68h9.48l5.88,15.6h-2.4l5.88-15.6h9.54l2.22,42h-7.92l-1.32-35.52,1.32.24-6.9,17.1h-3.24l-6.9-17.1,1.32-.24-1.32,35.52h-7.92l2.28-42Z"/>
      </g>
      </g>
      <g id="key-comma" class="key key--white">
      <g>
      <rect class="key__fill" x="1051" y="1" width="148" height="339"/>
      <path class="key__stroke" d="M1198,2v337h-146V2h146M1200,0h-150v341h150V0h0Z"/>
      </g>
      <g>
      <rect class="key__letter-background" x="1075" y="218" width="100" height="100" rx="17.8" ry="17.8"/>
      <path class="key__letter" d="M1119.84,279.58h10.32v11.1l-5.16,11.4h-8.28l9.9-13.5,1.02,2.1h-7.8v-11.1Z"/>
      </g>
      </g>
      <g>
      <rect class="key--black" x="103" width="94" height="181.79"/>
      <rect class="key--black" x="253" width="94" height="181.79"/>
      <rect class="key--black" x="553" width="94" height="181.79"/>
      <rect class="key--black" x="703" width="94" height="181.79"/>
      <rect class="key--black" x="853" width="94" height="181.79"/>
      </g>
    </svg>
  </div>

  

  <!-- Additional Visualization code -->
  <script>
    function drawGainPeaks(
      analyser,
      canvas,
      opts = { fillStyle: 'rgb(255, 255, 255)' }
    ) {
      const barWidth = 1;

      let then = new Date().getTime();
      const fps = 25;
      const interval = 1000 / fps;

      let ctx = canvas.getContext('2d');
      ctx.fillStyle = 'rgba(0, 0, 255, 0.5)';

      const WIDTH = canvas.width;
      const HEIGHT = canvas.height;

      const peaksCount = WIDTH;
      let peaks = new Array(WIDTH);
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength)

      function draw() {
        requestAnimationFrame(draw);

        // Timng vars for FPS
        var now = new Date().getTime();
        var delta = now - then;

        if (delta > interval) {
          then = now - (delta % interval);

          analyser.getByteFrequencyData(dataArray);
          let sum = 0
          for (const amplitude of dataArray) {
            sum += amplitude * amplitude
          }
          const currentLevel = Math.sqrt(sum / dataArray.length)

          if (currentLevel > -Infinity) {
            peaks.unshift(currentLevel);
          }

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          peaks.forEach((peak, index) => {
            ctx.fillStyle = opts.fillStyle;
            const barHeight = Math.max(1, peak);
            const x = barWidth * index;
            const y = HEIGHT / 2 - barHeight / 2;

            ctx.fillRect(x, y, barWidth, barHeight);

            // No need to keep record of peaks once waveform scrolls out of view
            if (peaks.length >= peaksCount) {
              peaks.splice(WIDTH);
            }
          });
        }
      }

      draw();
    }

    function drawOscilloscope(analyser, canvas) {
      const waveform = new Float32Array(analyser.frequencyBinCount);
      const ctx = canvas.getContext('2d');
      ctx.width = waveform.length;
      ctx.height = 100;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength)

      function draw() {
        requestAnimationFrame(draw);
        ctx.clearRect(0, 0, ctx.width, ctx.height);

        // Draw Frequency in Hz upper left corner
        analyser.getByteFrequencyData(dataArray);
        ctx.fillStyle = '#fff';
        ctx.font = '14px Courier';
        // Find the peak frequency bin
        let maxIndex = 0;
        let maxValue = 0;
        for (let i = 0; i < bufferLength; i++) {
          if (dataArray[i] > maxValue) {
            maxValue = dataArray[i];
            maxIndex = i;
          }
        }

        // Convert index to frequency
        const frequency = maxIndex * audioContext.sampleRate / analyser.fftSize;
        ctx.fillText(
          `Frequency: ${frequency} Hz`,
          10,
          20
        );

        // Draw Wave
        analyser.getFloatTimeDomainData(waveform);
        ctx.beginPath();
        for(let i = 0; i < waveform.length; i++) {
          const x = i;
          const y = ( 0.5 + (waveform[i] / 2) ) * ctx.height;

          if(i == 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      };
      draw();
    }
  </script>
</body>
